{% extends "bootstrap/base.html" %}

{% block head %}
{{super()}}
<link rel="stylesheet" href="static/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="static/css/spinner.css">
<link rel="stylesheet" href="static/css/spin_animate.css">
{% endblock %}

{% block title %}IoT Platform{% endblock %}

{% block navbar %}
{% include "navbar.html"%}
{% endblock %}


{% block content %}


<div class="row">
    <div class="col-md-3">
        <div class="panel panel-default">
            <div style="background-color: #FFF7AA;" class="panel-heading">
                <h3 style="color: black;" class="panel-title">Cameras</h3>
            </div>
            <div class="panel-body">
                <h5><b>Found</b></h5>
                <p id="no-cameras-p">-- None, please add. --</p>
                <div style="width: 250px; margin-bottom: 25px" class="pre-scrollable" id="jstree_demo_div"></div>

                <div class="btn-group" style="margin-bottom: 20px">
                    <button class="btn btn-primary ajax-button" id="take-photos-button" >
                        <span class="spinner"><i class="glyphicon glyphicon-refresh"></i></span>
                        Take Photos
                    </button>

                    <button class="btn btn-primary ajax-button" id="fetch-photos-button" >
                        <span class="spinner"><i class="glyphicon glyphicon-refresh"></i></span>
                        Fetch Photos
                    </button>
                </div>

                <h5><b>Add Camera</b></h5>
                <div class="form-group">
                    <input type="text" class="form-control" id="camera-address-txt" placeholder="Enter camera address" value="192.168.1.4">
                </div>

                <button class="btn btn-primary ajax-button" id="camera-search-button" >
                    <span class="spinner"><i class="glyphicon glyphicon-refresh"></i></span>
                    Search
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="panel panel-default">
            <div style="background-color: #FFF7AA;" class="panel-heading">
                <h3 style="color: black;" class="panel-title">Pictures</h3>
            </div>
            <div class="panel-body"></div>
                
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
{{super()}}
<script src="static/js/jstree/dist/jstree.min.js"></script>
<script src="static/js/camera.js"></script>
<script src="static/js/photo.js"></script>

<script type="text/javascript">
    console.log('Starting javascript excution on page.')

    var cameras = new Array();
    var camera_tree;
    var capture_photo_url = "/capture_photo";
    var fetch_photo_url = "/fetch_photo";
    var search_camera_url = "/search_camera";

    jQuery(document).ready(function () 
    {
        console.log('Document ready running jQuery commands.');

        $(".ajax-button").click(function(e)
        {
            console.log("Take photos button clicked: performing AJAX");
            console.log("Camera address: " + $("#camera-address-txt").val())

            var url = '';
            var data = '';

            if(this.id == 'take-photos-button')
            {
                url = capture_photo_url;
                data = { 'cameras': cameras }
                data = JSON.stringify(data, null, '\t');
            }
            else if(this.id == 'fetch-photos-button')
            {
                url = fetch_photo_url;
                data = { 'cameras': cameras }
                data = JSON.stringify(data, null, '\t');
            }
            else if(this.id == 'camera-search-button')
            {
                url = search_camera_url;
                data = JSON.stringify($("#camera-address-txt").val(), null, '\t');
            }

            activateButtonSpinner(this);
            e.preventDefault();

            $.ajax(
            {
                type: "POST",
                url: url,
                data: data,
                contentType: 'application/json;charset=UTF-8',
                success: function(raw_data, text_status, xhr)
                {
                    console.log("AJAX Request success -> ", xhr, " -> ", text_status)
                    console.log("Data -> ", raw_data)
                    deactivateButtonSpinner(this);

                    if(this.url == capture_photo_url)
                    {
                        takePhotosResult(raw_data, this)
                    }
                    else if(this.url == fetch_photo_url)
                    {
                        fetchPhotosResult(raw_data, this)
                    }
                    else if(this.url == search_camera_url)
                    {
                        searchCameraResult(raw_data, this);
                    }

                    handleNewTreeData();
                },
                complete : function(xhr, text_status) 
                {
                    console.log("AJAX Request complete -> ", xhr, " -> ", text_status)
                },
                error: function(xhr, text_status, error_thrown)
                {
                    console.log("AJAX Request error -> ", xhr, " -> ", text_status, " error -> ", error_thrown)
                    deactivateButtonSpinner(this);
                }
            });
        });


        function activateButtonSpinner(button)
        {
            var spin = $( button ).find( ".spinner" );
            spin.toggleClass('active');

            var icon = $( button ).find( ".glyphicon.glyphicon-refresh" );
            animateClass = "glyphicon-refresh-animate";
            icon.addClass( animateClass );

            // Disable all ajax buttons
            $( ".ajax-button" ).attr('disabled', "disabled")
        }

        function deactivateButtonSpinner(ajax)
        {
            var button =  '';

            if(ajax.url == capture_photo_url)
            {
                button = $( "#take-photos-button" );
            }
            else if(ajax.url == fetch_photo_url)
            {
                button = $( "#fetch-photos-button" );
            }
            else if(ajax.url == search_camera_url)
            {
                button = $( "#camera-search-button" );
            }

            var spin = $( button ).find( ".spinner" );
            spin.toggleClass('active');
            var icon = $( button ).find( ".glyphicon.glyphicon-refresh" );
            animateClass = "glyphicon-refresh-animate";
            icon.removeClass( animateClass );

            // Enable all ajax buttons
            $( ".ajax-button" ).removeAttr('disabled', "disabled")
        }

        function searchCameraResult(response, ajax)
        {
            var result = ajax.data.slice(1, -1);

            if(response == 'found')
            {
                cameras[cameras.length] = new Camera('host', result); 
                
            }
            else if(response == 'not_found')
            {
                // No camera dialog
            }
        }

        function takePhotosResult(response, ajax)
        {
            console.log(response);
            response_data = JSON.parse(response);
            var failed_cameras = new Array();

            for(i = 0; i < cameras.length; i++)
            {
                var camera = cameras[i];
                var camera_data = response_data[camera.ip_address]

                if(camera_data.sucess == true)
                {
                    camera.addPhotos(new Photos('-On Client-', ''));
                }
                else
                {
                    failed_cameras.push(camera);
                }
            }

            if(failed_cameras.length > 0)
            {
                // Capture failure dialog
            }
        }

        function fetchPhotosResult(response, ajax)
        {
            console.log(response);
            response_data = JSON.parse(response);

            for(i = 0; i < cameras.length; i++)
            {
                var camera = cameras[i];
                var camera_data = response_data[camera.ip_address]
                var new_photos = new Array();

                for(j = 0; j < camera_data.img_data.length; j++)
                {
                    var img_path = camera_data.img_data[j];
                    new_photos.push( new Photo('Photo' , img_path) );
                }

                camera.removePhotosWithoutPath();
                camera.addPhotos(new_photos);
            }
        }

        function handleNewTreeData()
        {
            console.log("Handle new tree data:");
            console.log(cameras);

            var no_camera_line = $('#no-cameras-p');
            if(no_camera_line.length != 0)
            {
                no_camera_line.remove();
            }
            else
            {
                $('#jstree_demo_div').jstree("destroy");
            }
            
            var data = createTree(cameras);
            camera_tree = { 
                            'core': 
                            { 
                                'data': data,
                            },
                          };

            console.log(camera_tree);

            $('#jstree_demo_div').jstree(camera_tree);

            $("#jstree_demo_div").bind("select_node.jstree", function(evt, eventData)
            {
                var selectedObject = eventData.node.data;
                var parentId = eventData.node.parent;
                var parentObjectSearch = $.grep(camera_tree.core.data, function(e){return e.id == parentId;});
                var parentObject;

                if(parentObjectSearch.length > 0)
                {
                    parentObject = parentObjectSearch[0].data;
                }

                // DO SOMETHING
            });
        }

        function createTree(cameras)
        {
            var data = []
    
            for(i = 0; i < cameras.length; i++)
            {
                var camera = cameras[i];
                var camera_id = 'camera' + (i+1)
                var camera_str = 'Camera ' + (i+1)
                var camera_node = createCamera(camera, camera_id, camera_str)
                console.log('Created camera: ' + camera_node)
                data.push(camera_node)

                for(j =0; j < camera.photos.length; j++)
                {
                    var photo = cameras[i].photos[j];
                    var photo_id = 'camera' + (i+1) + '_photo' + (j+1)
                    var photo_str = 'Photo ' + (j+1)
                    var photo_node = createPhoto(camera_id, photo, photo_id, photo_str)
                    console.log('Created photo: ' + photo_node)
                    data.push(photo_node)
                }
            }

            return data;
        }
        //'icon' : 'glyphicon glyphicon-camera',

        function createCamera(camera_data, camera_id, camera_str)
        {
            var data = []
            data = { 'id': camera_id, 
                     'parent': '#', 
                     'text': camera_str, 
                     'icon' : 'glyphicon glyphicon-camera', 
                     'state': { 'opened': true },
                     'li_attr': {}, 
                     'a_attr':  {}  
                    };

            return data
        }

        function createPhoto(camera_id, photo_data, photo_id, photo_str)
        {
            var data = []
            data = { 'id': photo_id, 
                     'parent': camera_id, 
                     'text': photo_str, 
                     'icon' : 'glyphicon glyphicon-picture', 
                     'li_attr': {}, 
                     'a_attr':  {}  
                    };

            return data
        }

        // Menu item
        $('#camera_menu_item').addClass('active');

    });

</script>
{% endblock %}

